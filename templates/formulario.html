<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Redacción topográfica v3.2 — Multitramos con auto-encadenar</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell; background:#0f172a; color:#e5e7eb;} 
    .wrap{ max-width: 1100px; margin: 40px auto; padding: 24px; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,.08); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .card h1{ margin: 0; padding: 20px 24px; border-bottom:1px solid rgba(255,255,255,.06); font-size: 22px; letter-spacing: .3px; }
    .content{ padding: 20px 24px; }
    label{ font-size: 12px; color: #9ca3af; }
    input[type="text"], input[type="number"], textarea{ width: 100%; padding: 10px 10px; border-radius: 10px; border:1px solid rgba(255,255,255,.08); background:#0b1220; color:#e5e7eb; outline:none; }
    textarea{ min-height: 48px; }
    table{ width:100%; border-collapse: collapse; margin-top: 10px;}
    th, td{ border-bottom:1px solid rgba(255,255,255,.08); padding:8px; vertical-align: top; }
    th{ text-align:left; color:#9ca3af; font-weight:600; }
    .btn{ appearance:none; border:0; background: var(--accent); color:#082f49; font-weight: 700; padding: 10px 14px; border-radius: 10px; cursor:pointer; }
    .btn.secondary{ background:#0b1220; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); }
    .row{ margin-top: 14px; }
    .out{ background:#0b1220; border:1px dashed rgba(255,255,255,.18); padding: 14px 16px; border-radius: 12px; margin-top:10px; }
    .err{ color:#fecaca; }
    code{ color:#93c5fd; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Redacción topográfica v3.2 — Multitramos con auto-encadenar</h1>
      <div class="content">
        <form method="post" id="form-tramos">
          <label style="display:inline-flex; gap:8px; align-items:center; margin-bottom:10px;">
            <input type="checkbox" name="convertir" checked>
            <span>Convertir números en estaciones a palabras (1 → uno)</span>
          </label>

          <table id="tabla">
            <thead>
              <tr>
                <th style="width:12%">Est. inicio</th>
                <th style="width:12%">Est. fin</th>
                <th style="width:30%">Rumbo (texto)</th>
                <th style="width:12%">Distancia (m)</th>
                <th>Colindancia</th>
                <th style="width:8%"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>

          <div class="row" style="display:flex; gap:10px;">
            <button class="btn secondary" type="button" onclick="agregarFila()">+ Agregar tramo</button>
            <button class="btn" type="submit">Generar redacción</button>
          </div>
        </form>

        {% if errores and errores|length %}
          <div class="out err">
            <strong>Revisa:</strong>
            <ul>{% for e in errores %}<li>{{ e }}</li>{% endfor %}</ul>
          </div>
        {% endif %}

        {% if resultado %}
          <div class="out">
            <p><strong>Redacción completa:</strong></p>
            <pre style="white-space:pre-wrap;">{{ resultado.redaccion_total }}</pre>
          </div>

          <div class="row">
            {% if docx_ready %}
              <form method="post" action="/descargar">
                <input type="hidden" name="payload_json" value='{{ {"tramos": resultado.tramos} | tojson | safe }}'>
                <button class="btn" type="submit">Descargar Word (.docx)</button>
              </form>
            {% else %}
              <div class="out err">
                python-docx no está disponible en el servidor. Agrega <code>python-docx</code> a <code>requirements.txt</code> y vuelve a desplegar.
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <template id="tpl-fila">
    <tr>
      <td><input type="text" name="est_ini[]" placeholder="1A"></td>
      <td><input type="text" name="est_fin[]" placeholder="1B"></td>
      <td>
        <input type="text" name="rumbo_texto[]" placeholder="N, 25, 35, 20, O">
        <div style="font-size:11px; color:#9ca3af; margin-top:4px;">Ej.: N, 25, 35, 20, O</div>
      </td>
      <td><input type="number" step="0.01" name="distancia[]" placeholder="0.00"></td>
      <td><textarea name="colindancia[]" placeholder="colinda con ..."></textarea></td>
      <td><button type="button" class="btn secondary" onclick="eliminarFila(this)">Quitar</button></td>
    </tr>
  </template>

  <script>
    function agregarFila() {
      const tpl = document.getElementById('tpl-fila').content.cloneNode(true);
      const tbody = document.getElementById('tbody');
      const lastRow = tbody.lastElementChild;
      tbody.appendChild(tpl);
      if (lastRow) {
        const lastFin = lastRow.querySelector('input[name="est_fin[]"]').value.trim();
        if (lastFin) {
          const newRow = tbody.lastElementChild;
          const ini = newRow.querySelector('input[name="est_ini[]"]');
          ini.value = lastFin;
        }
      }
    }
    function eliminarFila(btn) {
      const row = btn.closest('tr');
      row.remove();
    }
    window.addEventListener('DOMContentLoaded', () => agregarFila());
  </script>
</body>
</html>
